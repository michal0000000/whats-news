
// Block scrolling until document is ready
$.holdReady(true);
    setTimeout(function () {
        $.holdReady(false);
    }, 3000);

// Article scrolling functionality
$(document).ready(function () {

    document.getElementsByClassName("page-load")[0].style.display = "none";

    var page = 1;
    var block_request = false;
    var end_pagination = false;

    $(window).scroll(function () {
        if($(window).scrollTop() >= $('#articles').offset().top + $('#articles').outerHeight() - window.innerHeight && end_pagination === false && block_request === false) {
            
            block_request = true;
            page += 1;

            $.ajax({

                type: 'GET',
                url: '',
                data: {
                    "page": page
                },
                success: function (data) {

                    document.getElementsByClassName("more-content-load")[0].style.display = "none";
                    if (data.end_pagination === true) {
                        end_pagination = true;
                    } else {
                        document.getElementsByClassName("more-content-load")[0].style.display = "none";
                        block_request = false;
                    }


                    $('#articles').append(data.content);
                }
            })

            document.getElementsByClassName("more-content-load")[0].style.display = "block";
        }
    });
})


// An array and count to hold the new article elements
var newArticlesCount = 0;
var newArticles = [];

function fetchNewArticles() {
  $.getJSON("new_posts/", function(data) {

    if (data){
      // Iterate through the array of articles
      $.each(data.data, function(index, article) {

        // Get single article element
        var singleArticle = document.getElementById("single-article")

        // create clone based o nthat
        var newArticle = singleArticle.cloneNode(true)

        newArticle.querySelector(".headline").textContent = article.headline
        newArticle.querySelector(".subtitle").textContent = article.subtitle
        newArticle.querySelector(".article-link").setAttribute("href", article.link)
        newArticle.querySelector(".source-pfp").setAttribute("href", article.source_pfp)
        newArticle.querySelector(".published").setAttribute("href", article.published)

        // Handle author and source
        var articleInfo = newArticle.querySelector(".article-info");
        articleInfo.textContent = "";
      
        var articleSource = document.createElement("a");
        articleSource.classList.add(["article-source-name"]);
        articleSource.setAttribute("href", article.source_link);
        articleSource.setAttribute("target", "_blank");
        articleSource.textContent = article.source_display_name;
        articleInfo.append(articleSource);

        const textNode = document.createTextNode( " | " + article.authors );
        articleInfo.append(textNode)


        // Handle article image
        if (article.img_is_video == false){
          newArticle.querySelector(".article-img").src = article.image
        
        }else{
          // TODO: handle videos - not working ATM
          var articleImg = document.createElement("img");
          articleImg.src = "static/images/index.png" // Place holder
          articleImg.alt = "Article Video"
          articleImg.classList.add(["object-cover","object-center","rounded-lg"])

          // Replace old child
          var oldChild = newArticle.querySelector(".article-img");
          newArticle.replaceChild(articleImg,oldChild) // THIS FAILS 
        }

        // Add the article element to an array
        newArticles.push(newArticle);

        // Update the new articles count and button text
        newArticlesCount += 1;
        document.getElementById("new-articles-span").textContent = newArticlesCount + " new articles";

      });
    }
    if (newArticlesCount > 0){
      $("#new-articles-span").text(`${newArticlesCount} new articles`);
    }
  });
}

// Call the fetchNewArticles function every minute
setInterval(fetchNewArticles, 10000);


// A click handler for the new articles button
document.querySelector(".click-button").addEventListener("click", function() {
    // Add the new articles to the page
    var articles = document.getElementById("articles");
    newArticles.forEach(function(newArticle) {
      articles.prepend(newArticle);
    });
    // Clear the array of new articles
    newArticles.length = 0;
    // Reset the new articles count
    newArticlesCount = 0;
    // Update the button text
    document.getElementById("new-articles-span").textContent = "No new articles";
  });