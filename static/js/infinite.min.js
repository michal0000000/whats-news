
// Block scrolling until document is ready
$.holdReady(true);
    setTimeout(function () {
        $.holdReady(false);
    }, 3000);

// Article scrolling functionality
$(document).ready(function () {

    document.getElementsByClassName("page-load")[0].style.display = "none";

    var page = 1;
    var block_request = false;
    var end_pagination = false;

    $(window).scroll(function () {
        if($(window).scrollTop() >= $('#articles').offset().top + $('#articles').outerHeight() - window.innerHeight && end_pagination === false && block_request === false) {
            
            block_request = true;
            page += 1;

            $.ajax({

                type: 'GET',
                url: '',
                data: {
                    "page": page
                },
                success: function (data) {

                    document.getElementsByClassName("more-content-load")[0].style.display = "none";
                    if (data.end_pagination === true) {
                        end_pagination = true;
                    } else {
                        document.getElementsByClassName("more-content-load")[0].style.display = "none";
                        block_request = false;
                    }


                    $('#articles').append(data.content);
                }
            })

            document.getElementsByClassName("more-content-load")[0].style.display = "block";
        }
    });
})


// An array and count to hold the new article elements
var newArticlesCount = 0;
var newArticles = [];

function fetchNewArticles() {
  $.getJSON("new_posts/", function(data) {

    // Iterate through the array of articles
    $.each(data.data, function(index, article) {

      // Get single article element
      var singleArticle = document.getElementById("single-article")

      // create clone based o nthat
      var newArticle = singleArticle.cloneNode(true)

      newArticle.querySelector(".headline").textContent = article.headline
      newArticle.querySelector(".subtitle").textContent = article.subtitle
      newArticle.querySelector(".article-link").setAttribute("href", article.link)
      newArticle.querySelector(".source-pfp").setAttribute("href", article.source_pfp)
      newArticle.querySelector(".published").setAttribute("href", article.published)

      console.log(article)

      // Handle author and source
      var articleInfo = newArticle.querySelector(".article-info");
    
      var articleSource = document.createElement("a");
      articleSource.classList.add(["article-source-name"]);
      articleSource.setAttribute("href", article.source_link);
      articleSource.setAttribute("target", "_blank");
      articleSource.textContent = article.source_display_name;
      articleInfo.append(articleSource)

      articleInfo.textContent = "| " + article.authors;

      console.log("GOT HERE")


      // Handle article image
      if (article.img_is_video == false){
        var articleImg = document.createElement("img");
        articleImg.src = article.image
        articleImg.alt = "Article Image"
        articleImg.classList.add(["object-cover","object-center","rounded-lg","article-img"])

        // Replace old child
        var oldChild = newArticle.querySelector(".article-img");
        newArticle.removeChild(oldChild)

        console.log(newArticle)

        newArticle.replaceChild(articleImg,oldChild)
      
      }else{
        // TODO: handle videos
        var articleImg = document.createElement("img");
        articleImg.src = "static/images/index.png" // Place holder
        articleImg.alt = "Article Video"
        articleImg.classList.add(["object-cover","object-center","rounded-lg"])

        // Replace old child
        var oldChild = newArticle.querySelector(".article-img");
        newArticle.replaceChild(articleImg,oldChild)
      }

      console.log("GOT HERE1")

      // Add the article element to an array
      newArticles.push(articleElement);

      console.log("GOT HERE2")
      // Update the new articles count and button text
      newArticlesCount += 1;
      document.getElementById("new-articles-span").textContent = newArticlesCount + " new articles";

    });
    
    $("#new-articles-span").text(`${newArticlesCount} new articles`);
  });
}

// Call the fetchNewArticles function every minute
setInterval(fetchNewArticles, 10000);


// A click handler for the new articles button
document.querySelector(".click-button").addEventListener("click", function() {
    // Add the new articles to the page
    var articles = document.getElementById("articles");
    newArticles.forEach(function(newArticle) {
      articles.prepend(newArticle);
    });
    // Clear the array of new articles
    newArticles.length = 0;
    // Reset the new articles count
    newArticlesCount = 0;
    // Update the button text
    document.getElementById("new-articles-span").textContent = "No new articles";
  });